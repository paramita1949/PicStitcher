name: Build and Release PicStitcher

on:
  push:
    branches:
      - main
    paths:
      - 'main.py'  # åªæœ‰ main.py å˜åŒ–æ—¶æ‰æ£€æŸ¥

permissions:
  contents: write  # å…è®¸åˆ›å»º Release å’Œä¸Šä¼ æ–‡ä»¶

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.get_version.outputs.version }}
      version_changed: ${{ steps.check_version.outputs.changed }}
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 2  # è·å–æœ€è¿‘ä¸¤æ¬¡æäº¤ä»¥ä¾¿æ¯”è¾ƒ

    - name: Get current version
      id: get_version
      run: |
        VERSION=$(python .github/scripts/get_version.py)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Current version: $VERSION"

    - name: Check if version changed
      id: check_version
      run: |
        # è·å–ä¸Šä¸€æ¬¡æäº¤çš„ç‰ˆæœ¬å·
        git checkout HEAD~1 -- main.py 2>/dev/null || echo "No previous version"
        if [ -f main.py ]; then
          OLD_VERSION=$(python .github/scripts/get_version.py 2>/dev/null || echo "0.0.0")
        else
          OLD_VERSION="0.0.0"
        fi
        git checkout HEAD -- main.py

        CURRENT_VERSION="${{ steps.get_version.outputs.version }}"
        echo "Previous version: $OLD_VERSION"
        echo "Current version: $CURRENT_VERSION"

        if [ "$OLD_VERSION" != "$CURRENT_VERSION" ]; then
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "Version changed from $OLD_VERSION to $CURRENT_VERSION"
        else
          echo "changed=false" >> $GITHUB_OUTPUT
          echo "Version unchanged"
        fi

  build:
    needs: check-version
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements-minimal.txt
        pip install pyinstaller nuitka ordered-set zstandard

    - name: Install MSVC (required by Nuitka)
      uses: ilammy/msvc-dev-cmd@v1

    - name: Extract version number
      id: version
      run: |
        $version = "${{ needs.check-version.outputs.version }}"
        $tag = "v$version"

        # å¦‚æœç‰ˆæœ¬å·ä¸è¶³4æ®µï¼Œè¡¥å…….0
        $parts = $version -split '-'
        $numVersion = $parts[0]
        if ($numVersion -notmatch '^\d+\.\d+\.\d+\.\d+$') {
            if ($numVersion -match '^\d+\.\d+\.\d+$') {
                $numVersion = "$numVersion.0"
            } elseif ($numVersion -match '^\d+\.\d+$') {
                $numVersion = "$numVersion.0.0"
            } else {
                $numVersion = "1.5.0.0"
            }
        }
        echo "VERSION=$numVersion" >> $env:GITHUB_OUTPUT
        echo "TAG=$tag" >> $env:GITHUB_OUTPUT
        echo "Numeric version: $numVersion"
        echo "Tag: $tag"
      shell: powershell

    - name: Build with PyInstaller
      run: |
        pyinstaller --windowed --icon=icon.ico --add-data "icon.ico;." --hidden-import=PIL --hidden-import=numpy --hidden-import=tkinter --hidden-import=tkinter.ttk --hidden-import=tkinter.filedialog --hidden-import=tkinter.messagebox --hidden-import=tkinter.colorchooser --name "PicStitcher" --distpath dist-pyinstaller main.py
      shell: cmd

    - name: Verify PyInstaller build output
      run: |
        dir dist-pyinstaller\PicStitcher
        dir dist-pyinstaller\PicStitcher\PicStitcher.exe
      shell: cmd

    - name: Package PyInstaller distribution
      run: |
        cd dist-pyinstaller\PicStitcher
        7z a -tzip ..\..\PicStitcher-PyInstaller-${{ steps.version.outputs.TAG }}.zip *
        cd ..\..
        dir PicStitcher-PyInstaller-*.zip
      shell: cmd

    - name: Build with Nuitka
      run: |
        python -m nuitka --standalone --assume-yes-for-downloads --windows-console-mode=disable --enable-plugin=tk-inter --include-data-file=icon.ico=icon.ico --windows-icon-from-ico=icon.ico --windows-company-name="PicStitcher" --windows-product-name="PicStitcher ${{ steps.version.outputs.TAG }}" --windows-file-version="${{ steps.version.outputs.VERSION }}" --windows-product-version="${{ steps.version.outputs.VERSION }}" --windows-file-description="PicStitcher - å›¾ç‰‡æ™ºèƒ½æ‹¼æ¥å·¥å…·" --output-dir=build-nuitka --output-filename=PicStitcher.exe main.py
      shell: cmd

    - name: Verify Nuitka build output
      run: |
        dir build-nuitka\main.dist
        dir build-nuitka\main.dist\PicStitcher.exe
      shell: cmd

    - name: Package Nuitka distribution
      run: |
        cd build-nuitka\main.dist
        7z a -tzip ..\..\PicStitcher-Nuitka-${{ steps.version.outputs.TAG }}.zip *
        cd ..\..
        dir PicStitcher-Nuitka-*.zip
      shell: cmd
      
    - name: Create Git Tag
      run: |
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        git tag ${{ steps.version.outputs.TAG }}
        git push origin ${{ steps.version.outputs.TAG }}

    - name: Create Release and Upload Assets
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.TAG }}
        name: PicStitcher ${{ steps.version.outputs.TAG }}
        body: |
          ## PicStitcher ${{ steps.version.outputs.TAG }}

          ### ä¸»è¦åŠŸèƒ½ï¼š
          - å›¾ç‰‡æ™ºèƒ½æ‹¼æ¥
          - è‡ªåŠ¨è¯†åˆ«æ­Œæ›²ç¼–å·å’Œé¡µç 
          - æ”¯æŒå¤šç§æ–‡ä»¶åæ ¼å¼
          - æ‰¹é‡å¤„ç†å›¾ç‰‡
          - è‡ªå®šä¹‰èƒŒæ™¯é¢œè‰²
          - è‡ªåŠ¨ä¿å­˜é…ç½®

          ### ä¸‹è½½è¯´æ˜ï¼š
          æœ¬ç‰ˆæœ¬æä¾›ä¸¤ç§æ‰“åŒ…æ–¹å¼ï¼Œè¯·æ ¹æ®éœ€è¦é€‰æ‹©ï¼š

          #### ğŸš€ Nuitka ç‰ˆæœ¬ï¼ˆæ¨èï¼‰
          - æ–‡ä»¶ï¼š`PicStitcher-Nuitka-${{ steps.version.outputs.TAG }}.zip`
          - ç‰¹ç‚¹ï¼šå¯åŠ¨é€Ÿåº¦å¿«ï¼Œè¿è¡Œæ€§èƒ½ä¼˜ç§€
          - é€‚åˆï¼šæ—¥å¸¸ä½¿ç”¨ï¼Œè¿½æ±‚æ€§èƒ½

          #### ğŸ“¦ PyInstaller ç‰ˆæœ¬
          - æ–‡ä»¶ï¼š`PicStitcher-PyInstaller-${{ steps.version.outputs.TAG }}.zip`
          - ç‰¹ç‚¹ï¼šå…¼å®¹æ€§å¥½ï¼Œç¨³å®šå¯é 
          - é€‚åˆï¼šé‡åˆ°å…¼å®¹æ€§é—®é¢˜æ—¶ä½¿ç”¨

          ### ç³»ç»Ÿè¦æ±‚ï¼š
          - Windows 10/11
          - æ— éœ€é¢å¤–ä¾èµ–
          - æ— éœ€å®‰è£… Python ç¯å¢ƒ

          ### ä½¿ç”¨æ–¹æ³•ï¼š
          1. ä¸‹è½½ä»»æ„ä¸€ä¸ª ZIP æ–‡ä»¶
          2. è§£å‹åˆ°ä»»æ„ç›®å½•
          3. è¿è¡Œ `PicStitcher.exe`
          4. é€‰æ‹©åŒ…å«å›¾ç‰‡çš„æ–‡ä»¶å¤¹
          5. è®¾ç½®è¾“å‡ºç›®å½•
          6. ç‚¹å‡»"å¼€å§‹å¤„ç†"æŒ‰é’®
          7. ç­‰å¾…å¤„ç†å®Œæˆ

          ### æ”¯æŒçš„æ–‡ä»¶åæ ¼å¼ï¼š
          - `ç¬¬001é¦– æ­Œå1.jpg`
          - `001.æ­Œå1.jpg`
          - `ç¬¬0707æ„¿å°†æˆ‘çš„å¿ƒç»™ä½ 1.jpg`

          ### æŠ€æœ¯è¯´æ˜ï¼š
          - **Nuitka ç‰ˆæœ¬**ï¼šå°† Python ä»£ç ç¼–è¯‘ä¸ºåŸç”Ÿ C ä»£ç ï¼Œæ€§èƒ½æ›´ä¼˜
          - **PyInstaller ç‰ˆæœ¬**ï¼šä½¿ç”¨æˆç†Ÿçš„æ‰“åŒ…å·¥å…·ï¼Œå…¼å®¹æ€§æ›´å¥½
          - ä¸¤ä¸ªç‰ˆæœ¬åŠŸèƒ½å®Œå…¨ç›¸åŒï¼Œå¯æ ¹æ®ä¸ªäººå–œå¥½é€‰æ‹©

          ### æ›´æ–°æ—¥å¿—ï¼š
          è¯·æŸ¥çœ‹ [updata.txt](https://github.com/paramita1949/PicStitcher/blob/main/updata.txt) è·å–å®Œæ•´æ›´æ–°å†å²ã€‚
        files: |
          PicStitcher-PyInstaller-${{ steps.version.outputs.TAG }}.zip
          PicStitcher-Nuitka-${{ steps.version.outputs.TAG }}.zip
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

